<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
</head>

<body>
    <h2>SLAM Education</h2>
    <div>
        <div class="inputoutput">
            <img id="imageSrc" alt="No Image" hidden />
            <div class="caption"><input type="file" id="fileInput" name="file" /></div>
        </div>
        <div class="inputoutput">
            <input type="range" id="x0" value="0" min="-1000" max="1000" step="1" oninput="callback()">
            <input type="text" id="x0_text" size="3" value="0" />
            <input type="range" id="x1" value="0" min="-1000" max="1000" step="1" oninput="callback()">
            <input type="text" id="x1_text" size="3" value="0" />
            <input type="range" id="x2" value="0" min="-1000" max="1000" step="1" oninput="callback()">
            <input type="text" id="x2_text" size="3" value="0" />
            <canvas id="canvasOutput"></canvas>
        </div>
    </div>
    <script type="text/javascript">
        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
        }, false);

        imgElement.onload = function () {
            let src = cv.imread(imgElement);
            cv.imshow('canvasOutput', src);
            src.delete();
        };

        callback = function () {
            let src = cv.imread(imgElement);

            let x0 = document.getElementById('x0');
            let x1 = document.getElementById('x1');
            let x2 = document.getElementById('x2');

            x0_text.setAttribute('value', x0.value);
            x1_text.setAttribute('value', x1.value);
            x2_text.setAttribute('value', x2.value);

            let G0 = math.multiply(math.matrix([[0, -1, 0], [1, 0, 0], [0, 0, 0]]), x0.value / 100);
            let G1 = math.multiply(math.matrix([[0, 0, 1], [0, 0, 0], [0, 0, 0]]), x1.value);
            let G2 = math.multiply(math.matrix([[0, 0, 0], [0, 0, 1], [0, 0, 0]]), x2.value);

            let H_center = math.matrix([
                [1, 0, -src.cols / 2.0],
                [0, 1, -src.rows / 2.0],
                [0, 0, 1],
            ]);
            let H_center_inv = math.matrix([
                [1, 0, src.cols / 2.0],
                [0, 1, src.rows / 2.0],
                [0, 0, 1],
            ]);

            let e = math.multiply(H_center_inv, math.expm(math.add(G0, G1, G2)), H_center);

            let H = cv.matFromArray(3, 3, cv.CV_64FC1, [
                e.get([0, 0]),
                e.get([0, 1]),
                e.get([0, 2]),
                e.get([1, 0]),
                e.get([1, 1]),
                e.get([1, 2]),
                e.get([2, 0]),
                e.get([2, 1]),
                e.get([2, 2]),
            ]);

            let dst = new cv.Mat()
            let dsize = new cv.Size(src.rows, src.cols);
            cv.warpPerspective(src, dst, H, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
            cv.imshow('canvasOutput', dst);
            H.delete();
            dst.delete();

        };


    </script>
    <script async src="opencv.js" type="text/javascript"></script>
    <script async src="math.js" type="text/javascript"></script>
</body>

</html>